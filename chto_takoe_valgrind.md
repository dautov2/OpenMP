# Что такое Valgrind и для чего он нужен

Valgrind хорошо известен как мощное средство поиска ошибок работы с памятью. Но кроме этого, в его составе имеется некоторое количество дополнительных утилит, предназначенных для профилирования программ, анализа потребления памяти и поиска ошибок связанных с синхронизацией в многопоточных программах.

Данный раздел содержит краткое описание принципов работы с valgrind и использования различных его модулей. Данное описание соответствует valgrind версии 3.3. Дополнительную информацию о работе с valgrind вы можете найти на его сайте, который содержит руководства разного уровня сложности, начиная от достаточно легкого Quick Start, и заканчивая подробными руководством пользователя и техническим описанием системы.

####Архитектура Valgrind

Valgrind имеет модульную архитектуру, и состоит из ядра, которое выполняет эмуляцию процессора, а конкретные модули выполняют сбор и анализ информации, полученной во время выполнения кода на эмуляторе. Valgrind работает под управлением ОС Linux на процессорах x86, amd64, ppc32 и ppc64 (стоит отметить, что ведуться работы по переносу Valgrind и на другие ОС), при этом существуют некоторые ограничения, которые потенциально могут повлиять на работу исследуемых программ.1

В поставку valgrind входят следующие модули-анализаторы:

* **memcheck** - основной модуль, обеспечивающий обнаружение утечек памяти, и прочих ошибок, связанных с неправильной работой с областями памяти — чтением или записью за пределами выделенных регионов и т.п.
* **cachegrind** - анализирует выполнение кода, собирая данные о (не)попаданиях в кэш, и точках перехода (когда процессор неправильно предсказывает ветвление). Эта статистика собирается для всей программы, отдельных функций и строк кода
* **callgrind** - анализирует вызовы функций, используя примерно ту же методику, что и модуль cachegrind. Позволяет построить дерево вызовов функций, и соответственно, проанализировать узкие места в работе программы.
* **massif** -позволяет проанализировать выделение памяти различными частями программы
* **helgrind** -анализирует выполняемый код на наличие различных ошибок синхронизации, при использовании многопоточного кода, использующего POSIX Threads.

Имеется еще некоторое количество модулей, но они считаются экспериментальными и не отличаются особой стабильностью. Кроме того, пользователь может создавать свои модули, выполняющие анализ выполняемого кода.

####Начало работы с valgrind

В настоящее время valgrind входит в состав практически всех дистрибутивов Linux, и только в редких случаях требуется его установка вручную, поэтому я пропущу описание этого процесса2.

Работа с valgrind достаточно проста — его поведение полностью управляется опциями командной строки, а также не требует специальной подготовки программы, которую вы хотите проанализировать (Хотя все-таки рекомендуется пересобрать программу с отладочной информацией и отключенной оптимизацией используя флаги компиляции -g и -O0). Если программа запускается командой "программа аргументы", то для ее запуска под управлением valgrind, необходимо в начало этой командной строки добавить слово valgrind, и указать опции, необходимые для его работы. Например, так:

```
valgrind --leak-check=full --leak-resolution=med программа аргументы


```

что приведет к запуску нужной программы c заданными аргументами, и 
для нее будет проведен поиск утечек памяти.
По умолчанию, valgrind запускает модуль memcheck, однако пользователь может указать какой модуль должен выполняться с помощью опции --tool, передав в качестве аргумента имя нужного модуля, например, вот так:

```
valgrind --tool=callgrind ./test
```

Стоит отметить, что часто используемые опции можно задать один раз, используя глобальный файл конфигурации (~/.valgrindrc), так что вам не придется их набирать при каждом запуске valgrind.

Общие опции запуска программы
Некоторые опции командной строки являются общими для всех модулей. К наиболее часто используемым опциям можно отнести:

```
--quiet
(или -q) подавляет вывод лишней информации, приводя к выводу только информации 
об ошибках.

--verbose
(или -v) заставляет valgrind выводить подробную информацию о своей работе.

--log-file
позволяет задать имя файла в который будет выводиться отчет о работе.
В заданном имени могут использоваться специальные шаблоны, куда будут
подставляться различные значения, например, идентификатор процесса (шаблон %p).

--log-socket
позволяет задать адрес и порт на который будет передаваться отчет о работе.

--log-fd
позволяет указать дескриптор файла, в который будет выводиться отчет 
о работе (по умолчанию это число 2 — стандартный вывод сообщений об ошибках).

--track-fds
(yes или no, по умолчанию no) заставляет valgrind выдать список открытых
дескрипторов файлов при окончании работы.

--trace-children
(yes или no, по умолчанию no) разрешает трассировку процессов,
запущенных анализируемой программой с помощью системного вызова exec.

--time-stamp
(yes или no, по умолчанию no) приводит к выдаче временных меток
в отчет о работе (время отсчитывается от начала работы программы).
```


#### Опции управления обработкой ошибок

Пользователь valgrind имеет достаточно большой набор опций, предназначенных для управления процессом обработки ошибок — начиная от опций управления форматом вывода, и заканчивая опциями, задающими размер стека.

По умолчанию, valgrind при печати сообщения об ошибке выдает стек вызова функций, которые привели к появлению данной ошибки. По умолчанию глубина вложенности функций равна 12, но это значение можно изменить с помощью опции --num-callers. При этом стоит отметить, что увеличение этого параметра приведет к некоторому замедлению работы valgrind.

Пользователь также может управлять тем, сколько и каких ошибок будет выведено в отчет. Для этого имеется опция --error-limit (yes или no, по умолчанию yes), которая позволяет ограничить отчет выводом 1000 различных ошибок. Если пользователь не ограничивает вывод ошибок, то это также сказывается на производительности.

Кроме того, пользователь может управлять тем, какие ошибки будут выдаваться в отчет, а какие нет. Это делается с помощью задания специальных директив (suppressions), которые записываются в файлы, имена которых можно передать с помощью опции --suppressions. В поставке valgrind есть файл (обычно это /usr/lib/valgrind/default.supp), в котором перечислены известные ошибки glibc, но кроме того, пользователь может изготовить собственный файл, для чего можно использовать опцию --gen-suppressions, которая будет запрашивать пользователя, нужно ли сгенерировать директиву для данной ошибки, или нет.

Пользователь также имеет возможность запуска отладчика при нахождении ошибок. Для этого существует опция --db-attach (yes или no, по умолчанию no), при использовании которой у пользователя будет запрашиваться разрешение на запуск отладчика. Опции для запуска отладчика могут быть указаны с помощью опции --db-command, но значений по умолчанию вполне достаточно для большинства случаев.

#### Поиск утечек памяти

Valgrind приобрел популярность в первую очередь за свои возможности по нахождению утечек памяти в программах. За этот реализацию этих функций отвечает модуль memcheck, для которого определены отдельные опции, управляющие процессом проверки.
```
--leak-check
включает (значение yes, summary или full) или отключает (значение no) функцию
обнаружения утечек памяти. Стоит отметить, что при использовании значения summary,
memcheck выдает лишь краткую информацию об утечках памяти, тогда как при других
значениях, кроме сводной информации, будет выдаваться еще и информация о месте, в
котором происходит эта утечка памяти.

--leak-resolution
(возможные значения low, med или high) указывает способ сравнения стека вызовов функций.
При значениях low и med, в сравнении используются два или четыре последних вызова,
соответственно, а при high, сравнивается полный стек вызова. 
Эта опция влияет лишь на способ представления результатов поиска ошибок.

--undef-value-errors
(yes или no) определяет, будут ли показывать ошибки об использовании не
инициализированных значений.
```

Прочие опции используются значительно реже, и в случае необходимости вы можете найти их описание в руководстве пользователя.
#### Интерпретация полученных результатов

Существует несколько видов ошибок, обнаруживаемых модулем memcheck. Ошибки чтения и записи за пределами выделенной памяти (и еще несколько видов ошибок) выдаются сразу, в процессе работы программы. А ошибки, ведущие к утечкам памяти, выдаются valgrind'ом после завершения работы анализируемой программы. Формат выдачи этих ошибок немного отличается, поэтому они будут описаны по отдельности.

Каждая строка в выводе valgrind имеет префикс вида
```
==12345==
```
где число обозначает идентификатор запущенного процесса.
#### Ошибки работы с памятью

В ходе своей работы, модуль memcheck определяет несколько видов ошибок работы с памятью:
* чтение или запись по неправильным адресам памяти — за границами выделенных блоков памяти и т.п.
* использование не инициализированных значений, в том числе и для переменных выделяемых на стеке
* ошибки освобождения памяти, например, когда блок памяти уже был освобожден в другом месте
* использование "неправильной" функции освобождения памяти, например использование delete для памяти, выделенной с помощью new []
* передача некорректных параметров системным вызовам, например указание неправильных указателей для операций чтения из буфера, указанного пользователем
пересечение границ блоков памяти при использовании операций копирования/перемещения данных между двумя блоками памяти

Для этих ошибок данные выдаются по мере их обнаружения, и обычно они выглядят следующим образом:
```
Mismatched free() / delete / delete []
   at 0x40043249: free (vg_clientfuncs.c:171)
   by 0x4102BB4E: QGArray::~QGArray(void) (tools/qgarray.cpp:149)
   by 0x4C261C41: PptDoc::~PptDoc(void) (include/qmemarray.h:60)
   by 0x4C261F0E: PptXml::~PptXml(void) (pptxml.cc:44)
 Address 0x4BB292A8 is 0 bytes inside a block of size 64 alloc'd
   at 0x4004318C: operator new[](unsigned int) (vg_clientfuncs.c:152)
   by 0x4C21BC15: KLaola::readSBStream(int) const (klaola.cc:314)
   by 0x4C21C155: KLaola::stream(KLaola::OLENode const *) (klaola.cc:416)
   by 0x4C21788F: OLEFilter::convert(QCString const &) (olefilter.cc:272)
 ```

В первой строке приводится описание соответствующей ошибки, а затем идет стек вызова функций, приведших к появлению данной ошибки. В том случае, где это необходимо (как в нашем примере), выдается также адрес блока памяти и место где этот блок памяти был выделен.

#### Нахождение утечек памяти

