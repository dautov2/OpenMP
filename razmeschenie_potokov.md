# Размещение потоков

По умолчению, OpenMP потокам разрешено мигрировать между логическими и физическими ядрами во время выполения приложения. Это часто становится причиной падения производительности. Поток мигрирует с физического ядра на другое он и при этом теряет доступ к данным, находящимся в локалном кэше ядра. Данные, для дальнейшей работы, нужно заново загружать в локальный кэш нового ядра. Увеличить производительность приложение возможно путем привязки OpenMP потоков к логическими или физическими ядрам. Привязка потоков называется thread affinity.

В различных компиляторах до принятия стандарта OpenMP 4.0 были собственные реализации шаблонов размещения потоков. Например, KMP_AFFINITY, для компиляторов от компании Intel.

Теперь же стандартизирована политика размещения потоков. Как размещать потоки мы можем указать в коде или же через переменные окружения.
Существует на данный момент три политики размещения.

* spread - распределить потоки равномерно
* close -  размещать потоки последовательно как можно ближе к мастер потоку 
* master - размещать потоки на том же месте где и мастер поток

```
#pragma omp parallel proc_bind(spread)

#pragma omp parallel proc_bind(close)

#pragma omp parallel proc_bind(master)
```


Переменные окружения 
```

export OMP_PROC_BIND= "spread"
export OMP_PROC_BIND= "close"
export OMP_PROC_BIND= "master"
export OMP_PROC_BIND= "true"
export OMP_PROC_BIND= "false"

export OMP_PLACES="{0,1,2,3}{4,5,6,7}{8:4}"```



Заметье, когда мы устанавливаем политику размещения через переменные окружения у нас появляются еще два варианта это true и false.

Какие же настройки нам применить? Вначале мы должны увидеть настройки по умолчанию. Поэтому заранее установите следующую переменную окружения.

```
set OMP_DISPLAY_ENV=true
```

Установив ее на true, программа выведет все переменные окружения, которые выставлены по умолчанию.

Так же можно комбинировать в случае необходимости политики распределения. 
Пример.
Как распределить потоки внешнего цикла равномерно между всеми физическими ядрами, а потоки внутренего цикла последовательно друг за другом?

```
#pragma omp parallel proc_bind(spread)
{
    #pragma omp parallel proc_bind(close)
    {
    
    ....
    }

}

```


